---
description: Clean architecture with CQRS patterns and constraints
alwaysApply: true
---

# Architecture Rules

Maintain clean/onion architecture with CQRS. Dependencies point inward only.

## Layer Structure

```
Presentation → Infrastructure → Application → Domain
```

| Layer | Location | Depends On | Contains |
|-------|----------|------------|----------|
| Domain | `Core/Domain/` | Nothing | Entities |
| Application | `Core/Application/` | Domain | Features, DTOs, Interfaces |
| Infrastructure | `Infrastructure/` | Application | SQLServer, Redis, RabbitMQ, Bootstrap |
| Presentation | `Presentation/` | Infrastructure | Controllers, Angular app |

## CQRS Flow

```
WebAPI Request → Command/Query → Handler → DTO → WebAPI Response
```

### Feature Organization

```
Features/{Entity}/
├── {Entity}s.cs                         # Facade
├── I{Entity}s.cs                        # Facade interface
└── {Action}{Entity}/
    ├── {Action}{Entity}Command.cs       # Request
    ├── {Action}{Entity}CommandHandler.cs
    ├── I{Action}{Entity}CommandHandler.cs
    └── {Entity}{Action}Event.cs         # Domain event (if applicable)
```

### Handler Responsibilities

1. Validate (throw `ValidationException` for invalid input)
2. Create/modify domain entities
3. Persist via `IRepository`
4. Cache via `ICache`
5. Publish via `IEventHub`
6. Return DTO (never domain entity)

## Approval Required

Do not change without explicit consent:
- NuGet packages
- SDK/framework versions
- New `.csproj` projects
