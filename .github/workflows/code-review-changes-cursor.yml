name: Code Review Changes Cursor

on:
  pull_request:
    types: [converted_to_draft]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  code-review-changes-cursor:
    runs-on: ubuntu-latest

    steps:

      - name: Check if triggered by automated workflow
        id: check-trigger
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Only proceed if the issue has Code-Review or Tests-Failed label
          # This prevents triggering on manual draft conversions
          ISSUE_NUMBER=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body' --repo ${{ github.repository }} | grep -oiP '(closes|fixes|resolves) #\K\d+' | head -1)
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "::warning::No linked issue found in PR body"
            exit 0
          fi
          
          # Get all labels on the issue
          LABELS=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          
          # Check if issue has Code-Review label (set by code-review workflow)
          HAS_CODE_REVIEW=$(echo "$LABELS" | grep -c "^Code-Review$" || true)
          # Check if issue has Tests-Failed label (set by functional validation workflow)
          HAS_TESTS_FAILED=$(echo "$LABELS" | grep -c "^Tests-Failed$" || true)
          
          if [ "$HAS_CODE_REVIEW" != "0" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "trigger_type=code-review" >> $GITHUB_OUTPUT
            echo "Triggered by code review agent (Code-Review label found)"
          elif [ "$HAS_TESTS_FAILED" != "0" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "trigger_type=tests-failed" >> $GITHUB_OUTPUT
            echo "Triggered by test failure (Tests-Failed label found)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "::notice::Skipping - PR was not converted to draft by automated workflow (missing Code-Review or Tests-Failed label)"
          fi

      - name: Transition label to Implementing-Changes
        if: steps.check-trigger.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all current labels and remove them
          CURRENT_LABELS=$(gh issue view ${{ steps.check-trigger.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          for label in $CURRENT_LABELS; do
            gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --add-label "Implementing-Changes" --repo ${{ github.repository }}

      - name: Checkout repository
        if: steps.check-trigger.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run install tools script
        if: steps.check-trigger.outputs.should_run == 'true'
        shell: pwsh
        run: ./scripts/install_tools.ps1

      - name: Install ripgrep
        if: steps.check-trigger.outputs.should_run == 'true'
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Install Cursor CLI
        if: steps.check-trigger.outputs.should_run == 'true'
        run: |
          curl -fsSL https://cursor.com/install | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Implement Changes Cursor Agent
        if: steps.check-trigger.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CURSOR_TOKEN: ${{ secrets.CURSOR_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PROMPT=$(cat .agents/7-implement-changes-prompt.txt)
          PROMPT="${PROMPT} The PR number is #${PR_NUMBER}."
          agent --force --api-key "$CURSOR_TOKEN" -p "$PROMPT"

      - name: Handle success - check if PR was marked ready or needs manual attention
        if: success() && steps.check-trigger.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR is still in draft (agent couldn't fix the issue)
          IS_DRAFT=$(gh pr view ${{ github.event.pull_request.number }} --json isDraft --jq '.isDraft' --repo ${{ github.repository }})
          
          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR is still in draft - agent could not fully resolve the issues"
            # Get all current labels and remove them
            CURRENT_LABELS=$(gh issue view ${{ steps.check-trigger.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
            for label in $CURRENT_LABELS; do
              gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
            done
            gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --add-label "Manual-Attention-Required" --repo ${{ github.repository }}
            gh pr comment ${{ github.event.pull_request.number }} --body "Implement Changes agent completed but could not fully resolve all issues. Manual intervention required." --repo ${{ github.repository }}
          else
            echo "PR was marked ready - agent fixed the issues"
            # Get all current labels and remove them - the PR ready event triggers functional validation
            # which will run tests and set the appropriate label
            CURRENT_LABELS=$(gh issue view ${{ steps.check-trigger.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
            for label in $CURRENT_LABELS; do
              gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
            done
          fi

      - name: Add Agent-Failed label on failure
        if: failure() && steps.check-trigger.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --add-label "Agent-Failed" --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Implement Changes agent failed. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Handle cancellation
        if: cancelled() && steps.check-trigger.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.check-trigger.outputs.issue_number }} --add-label "Agent-Cancelled" --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Implement Changes agent was cancelled. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}
