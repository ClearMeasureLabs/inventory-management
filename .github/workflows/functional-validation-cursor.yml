name: Functional Validation

on:
  pull_request:
    types: [ready_for_review]

jobs:
  functional-validation:
    runs-on: ubuntu-latest

    steps:

      - name: Get linked issue number
        id: get-issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get linked issue number from PR body (supports Closes, Fixes, Resolves - case insensitive)
          ISSUE_NUMBER=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body' --repo ${{ github.repository }} | grep -oiP '(closes|fixes|resolves) #\K\d+' | head -1)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::warning::No linked issue found in PR body. Expected 'Closes #N', 'Fixes #N', or 'Resolves #N'"
          fi

      - name: Transition label to Build-Test
        if: steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Remove all workflow labels before adding new one
          LABELS_TO_REMOVE="UX-Design-Ready,UX-Design,Technical-Design-Ready,Technical-Design,Test-Design-Ready,Test-Design,Development-Ready,Development,Code-Review-Ready,Code-Review,Build-Test,Tests-Passed,Tests-Failed,Implementing-Changes,Agent-Failed,Agent-Cancelled,Manual-Attention-Required"
          for label in $(echo $LABELS_TO_REMOVE | tr ',' ' '); do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Build-Test" --repo ${{ github.repository }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run install tools script
        shell: pwsh
        run: ./scripts/install_tools.ps1

      - name: Start Docker services
        run: |
          docker compose -f environments/local/docker-compose.yml up -d
          # Wait for services to be ready
          sleep 30

      - name: Run unit and integration tests
        id: unit-integration-tests
        shell: pwsh
        run: ./scripts/build_and_test.ps1

      - name: Run acceptance tests
        id: acceptance-tests
        shell: pwsh
        run: ./scripts/acceptance_tests.ps1

      - name: Transition label to Tests-Passed on success
        if: success() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Remove all workflow labels before adding new one
          LABELS_TO_REMOVE="UX-Design-Ready,UX-Design,Technical-Design-Ready,Technical-Design,Test-Design-Ready,Test-Design,Development-Ready,Development,Code-Review-Ready,Code-Review,Build-Test,Tests-Passed,Tests-Failed,Implementing-Changes,Agent-Failed,Agent-Cancelled,Manual-Attention-Required"
          for label in $(echo $LABELS_TO_REMOVE | tr ',' ' '); do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Tests-Passed" --repo ${{ github.repository }}

      - name: Transition label and convert PR to draft on test failure
        if: failure() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Tests failed - converting PR to draft to trigger implement changes agent"
          # Remove all workflow labels before adding new one
          LABELS_TO_REMOVE="UX-Design-Ready,UX-Design,Technical-Design-Ready,Technical-Design,Test-Design-Ready,Test-Design,Development-Ready,Development,Code-Review-Ready,Code-Review,Build-Test,Tests-Passed,Tests-Failed,Implementing-Changes,Agent-Failed,Agent-Cancelled,Manual-Attention-Required"
          for label in $(echo $LABELS_TO_REMOVE | tr ',' ' '); do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Tests-Failed" --repo ${{ github.repository }}
          # Convert to draft - this triggers the code-review-changes workflow
          gh pr ready --undo ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Build/Test failed. Converting to draft to trigger automated fixes. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Handle cancellation
        if: cancelled() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Agent-Cancelled" --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Build/Test was cancelled. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Stop Docker services
        if: always()
        run: |
          docker compose -f environments/local/docker-compose.yml down
