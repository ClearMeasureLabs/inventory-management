name: Code Review Cursor

on:
  workflow_run:
    workflows: ["Functional Validation"]
    types: [completed]

jobs:
  code-review-cursor:
    # Only run if functional validation workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:

      - name: Get PR number and details from triggering workflow
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get PR number from the head SHA of the triggering workflow
          # Use --state all in case PR was just merged or closed
          PR_DATA=$(gh pr list --state open --json number,headRefOid,headRefName --jq '.[] | select(.headRefOid == "${{ github.event.workflow_run.head_sha }}")' --repo ${{ github.repository }} | head -1)
          
          if [ -z "$PR_DATA" ]; then
            echo "::error::Could not find open PR for commit ${{ github.event.workflow_run.head_sha }}"
            echo "pr_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_found=true" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER on branch $PR_BRANCH"

      - name: Get linked issue number
        id: get-issue
        if: steps.get-pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get linked issue number from PR body (supports Closes, Fixes, Resolves - case insensitive)
          ISSUE_NUMBER=$(gh pr view ${{ steps.get-pr.outputs.pr_number }} --json body --jq '.body' --repo ${{ github.repository }} | grep -oiP '(closes|fixes|resolves) #\K\d+' | head -1)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::warning::No linked issue found in PR body. Expected 'Closes #N', 'Fixes #N', or 'Resolves #N'"
          fi

      - name: Transition label to Code-Review
        if: steps.get-pr.outputs.pr_found == 'true' && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get all current labels and remove them
          CURRENT_LABELS=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          for label in $CURRENT_LABELS; do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Code-Review" --repo ${{ github.repository }}

      - name: Checkout repository
        if: steps.get-pr.outputs.pr_found == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Run install tools script
        if: steps.get-pr.outputs.pr_found == 'true'
        shell: pwsh
        run: ./scripts/install_tools.ps1

      - name: Install ripgrep
        if: steps.get-pr.outputs.pr_found == 'true'
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Install Cursor CLI
        if: steps.get-pr.outputs.pr_found == 'true'
        run: |
          curl -fsSL https://cursor.com/install | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Code Review Cursor Agent
        if: steps.get-pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CURSOR_TOKEN: ${{ secrets.CURSOR_TOKEN }}
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          PROMPT=$(cat .agents/6-code-review-prompt.txt)
          PROMPT="${PROMPT} The PR number is #${PR_NUMBER}."
          agent --force --api-key "$CURSOR_TOKEN" -p "$PROMPT"

      - name: Add Approved by Agent label if PR still ready for review
        if: success() && steps.get-pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Check if PR is still ready for review (not converted to draft)
          # Agent converts PR to draft with 'gh pr ready --undo' when requesting changes
          IS_DRAFT=$(gh pr view ${{ steps.get-pr.outputs.pr_number }} --json isDraft --jq '.isDraft' --repo ${{ github.repository }})
          if [ "$IS_DRAFT" = "false" ]; then
            echo "PR is still ready for review - agent approved"
            gh pr edit ${{ steps.get-pr.outputs.pr_number }} --add-label "Approved by Agent" --repo ${{ github.repository }}
          else
            echo "PR was converted to draft - agent requested changes"
          fi

      - name: Add Agent-Failed label on failure
        if: failure() && steps.get-pr.outputs.pr_found == 'true' && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Agent-Failed" --repo ${{ github.repository }}
          gh pr comment ${{ steps.get-pr.outputs.pr_number }} --body "Code Review agent failed. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Handle cancellation
        if: cancelled() && steps.get-pr.outputs.pr_found == 'true' && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Agent-Cancelled" --repo ${{ github.repository }}
          gh pr comment ${{ steps.get-pr.outputs.pr_number }} --body "Code Review agent was cancelled. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}
