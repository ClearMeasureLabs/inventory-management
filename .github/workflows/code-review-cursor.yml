name: Code Review Cursor

on:
  pull_request:
    types: [ready_for_review]

jobs:
  code-review-cursor:
    runs-on: ubuntu-latest

    steps:

      - name: Transition label to Code-Review
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get linked issue number from PR body
          ISSUE_NUMBER=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body' --repo ${{ github.repository }} | grep -oP 'Closes #\K\d+' | head -1)
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue edit $ISSUE_NUMBER --remove-label "Code-Review-Ready" --add-label "Code-Review" --repo ${{ github.repository }}
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run install tools script
        shell: pwsh
        run: ./scripts/install_tools.ps1

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Install Cursor CLI
        run: |
          curl -fsSL https://cursor.com/install | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Code Review Cursor Agent
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CURSOR_TOKEN: ${{ secrets.CURSOR_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PROMPT=$(cat .agents/6-code-review-prompt.txt)
          PROMPT="${PROMPT} The PR number is #${PR_NUMBER}."
          agent --force --api-key "$CURSOR_TOKEN" -p "$PROMPT"

      - name: Add Approved by Agent label if PR still ready for review
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Check if PR is still ready for review (not converted to draft)
          # Agent converts PR to draft with 'gh pr ready --undo' when requesting changes
          IS_DRAFT=$(gh pr view ${{ github.event.pull_request.number }} --json isDraft --jq '.isDraft' --repo ${{ github.repository }})
          if [ "$IS_DRAFT" = "false" ]; then
            echo "PR is still ready for review - agent approved"
            gh pr edit ${{ github.event.pull_request.number }} --add-label "Approved by Agent" --repo ${{ github.repository }}
          else
            echo "PR was converted to draft - agent requested changes"
          fi
