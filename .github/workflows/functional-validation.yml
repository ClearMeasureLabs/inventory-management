name: Functional Validation

on:
  pull_request:
    types: [ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  functional-validation:
    runs-on: ubuntu-latest

    steps:

      - name: Get linked issue number
        id: get-issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get linked issue number from PR body (supports Closes, Fixes, Resolves - case insensitive)
          ISSUE_NUMBER=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body' --repo ${{ github.repository }} | grep -oiP '(closes|fixes|resolves) #\K\d+' | head -1)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::warning::No linked issue found in PR body. Expected 'Closes #N', 'Fixes #N', or 'Resolves #N'"
          fi

      - name: Transition label to Functional-Validation
        if: steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all current labels and remove them
          CURRENT_LABELS=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          for label in $CURRENT_LABELS; do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Functional-Validation" --repo ${{ github.repository }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run install tools script
        shell: pwsh
        run: ./scripts/install_tools.ps1

      - name: Clean up any stale Docker containers
        working-directory: environments/local
        run: |
          docker compose -p ivan_infra down --volumes --remove-orphans 2>/dev/null || true
          docker rm -f sqlserver rabbitmq redis redis-insight 2>/dev/null || true

      - name: Start Docker services
        working-directory: environments/local
        shell: pwsh
        run: |
          ./provision.ps1
          # Wait for services to be ready
          Start-Sleep -Seconds 30

      - name: Run unit and integration tests
        id: unit-integration-tests
        shell: pwsh
        run: ./scripts/build_and_test.ps1

      - name: Run acceptance tests
        id: acceptance-tests
        shell: pwsh
        run: ./scripts/acceptance_tests.ps1

      - name: Transition label to Tests-Passed on success
        if: success() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all current labels and remove them
          CURRENT_LABELS=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          for label in $CURRENT_LABELS; do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Tests-Passed" --repo ${{ github.repository }}

      - name: Transition label and convert PR to draft on test failure
        if: failure() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Functional validation failed - converting PR to draft to trigger implement changes agent"
          # Get all current labels and remove them
          CURRENT_LABELS=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json labels --jq '.labels[].name' --repo ${{ github.repository }})
          for label in $CURRENT_LABELS; do
            gh issue edit ${{ steps.get-issue.outputs.issue_number }} --remove-label "$label" --repo ${{ github.repository }} 2>/dev/null || true
          done
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Tests-Failed" --repo ${{ github.repository }}
          # Convert to draft - this triggers the code-review-changes workflow
          gh pr ready --undo ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Functional validation failed. Converting to draft to trigger automated fixes. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Handle cancellation
        if: cancelled() && steps.get-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --add-label "Agent-Cancelled" --repo ${{ github.repository }}
          gh pr comment ${{ github.event.pull_request.number }} --body "Functional validation was cancelled. Check workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" --repo ${{ github.repository }}

      - name: Stop Docker services
        if: always()
        working-directory: environments/local
        run: |
          docker compose -p ivan_infra down --volumes --remove-orphans 2>/dev/null || true
          docker compose -p ivan_app down --volumes --remove-orphans 2>/dev/null || true
          docker rm -f sqlserver rabbitmq redis redis-insight webapp webapi 2>/dev/null || true
