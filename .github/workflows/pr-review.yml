name: PR Code Review

on:
  pull_request:
    types: [ready_for_review]
    branches:
      - master
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

jobs:
  code-review:
    name: Cursor Cloud Agent Review
    runs-on: ubuntu-latest
    # Skip if PR is still a draft (only applies to pull_request event)
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.draft == false
    
    steps:
      - name: Log trigger info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "PR Number: ${{ github.event.pull_request.number }}"
            echo "PR Title: ${{ github.event.pull_request.title }}"
            echo "Head Branch: ${{ github.head_ref }}"
            echo "Base Branch: ${{ github.base_ref }}"
          else
            echo "Manual trigger with PR: ${{ inputs.pr_number }}"
          fi

      - name: Get PR details (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        id: pr_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh pr view ${{ inputs.pr_number }} --repo ${{ github.repository }} --json number,title,body,headRefName,baseRefName)
          echo "pr_number=$(echo $PR_DATA | jq -r '.number')" >> $GITHUB_OUTPUT
          echo "pr_title=$(echo $PR_DATA | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo $PR_DATA | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "head_branch=$(echo $PR_DATA | jq -r '.headRefName')" >> $GITHUB_OUTPUT
          echo "base_branch=$(echo $PR_DATA | jq -r '.baseRefName')" >> $GITHUB_OUTPUT

      - name: Trigger Cursor Cloud Agent Review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          # Use PR event data or manual input data
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.pr_number || github.event.pull_request.number }}
          PR_TITLE: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.pr_title || github.event.pull_request.title }}
          PR_BODY: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.pr_body || github.event.pull_request.body }}
          HEAD_BRANCH: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.head_branch || github.head_ref }}
          BASE_BRANCH: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.base_branch || github.base_ref }}
        run: |
          echo "Preparing to call Cursor Cloud Agent API..."
          echo "PR Number: ${PR_NUMBER}"
          echo "Head Branch: ${HEAD_BRANCH}"
          echo "Repository: ${{ github.repository }}"
          
          # Build the prompt text with all PR context
          PROMPT_TEXT="Review PR #${PR_NUMBER} in repository ${{ github.repository }}.

Follow the code_review_rules to review the changes:
1. Reference the associated issue to understand requirements
2. Review the changes against the PR template checklist
3. Check architecture rules, testing requirements, and documentation
4. Post a review comment with the checklist findings
5. Approve if all checks pass, or request changes with specific feedback

PR Title: ${PR_TITLE}
PR Branch: ${HEAD_BRANCH} -> ${BASE_BRANCH}"
          
          # Build the request payload using the correct API format
          PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT_TEXT" \
            --arg repo "${{ github.repository }}" \
            --arg ref "$HEAD_BRANCH" \
            '{
              "prompt": {
                "text": $prompt
              },
              "source": {
                "repository": $repo,
                "ref": $ref
              }
            }')
          
          echo "Request payload:"
          echo "$PAYLOAD" | jq .
          
          # Make the API call and capture response
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.cursor.com/v0/agents" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CURSOR_API_KEY" \
            -d "$PAYLOAD")
          
          # Extract body and status code
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n 1)
          
          echo "API Response Status: $HTTP_STATUS"
          echo "API Response Body: $HTTP_BODY"
          
          # Check if successful
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "Successfully triggered Cursor Cloud Agent review"
          else
            echo "Failed to trigger Cursor Cloud Agent review"
            echo "Status: $HTTP_STATUS"
            echo "Response: $HTTP_BODY"
            exit 1
          fi
